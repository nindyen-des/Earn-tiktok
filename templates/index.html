<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facebook Follower Bot</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-robot"></i> Facebook Follower Booster</h1>
            <p>Boost your Facebook followers using zefame API with proxy rotation</p>
            <div class="api-info">
                <span class="api-status" id="apiStatus">Checking API...</span>
                <button class="btn-small" id="testApiBtn">
                    <i class="fas fa-sync-alt"></i> Test API
                </button>
                <button class="btn-small btn-warning" id="clearCacheBtn">
                    <i class="fas fa-trash"></i> Clear Cache
                </button>
            </div>
        </div>
        
        <div class="content">
            <div class="card">
                <h2><i class="fas fa-cogs"></i> Configuration</h2>
                
                <form id="followerForm" method="POST">
                    <div class="form-group">
                        <label for="facebook_url">
                            <i class="fab fa-facebook"></i> Facebook Profile URL:
                        </label>
                        <input type="url" id="facebook_url" name="facebook_url" 
                               placeholder="https://www.facebook.com/profile.php?id=100123456789 or https://www.facebook.com/username"
                               required>
                        <div class="input-hint">
                            <i class="fas fa-info-circle"></i> Must be a public Facebook profile URL
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="operation_mode">
                            <i class="fas fa-sliders-h"></i> Operation Mode:
                        </label>
                        <select id="operation_mode" name="operation_mode" class="form-control">
                            <option value="single">Single Boost (One-time)</option>
                            <option value="continuous">Continuous Mode (Testing)</option>
                        </select>
                        <div class="input-hint">
                            <i class="fas fa-info-circle"></i> Note: zefame API has 24-hour cooldown per profile
                        </div>
                    </div>
                    
                    <div class="form-group" id="durationGroup" style="display: none;">
                        <label for="duration">
                            <i class="fas fa-clock"></i> Duration (seconds):
                        </label>
                        <input type="number" id="duration" name="duration" value="30" min="5" max="3600">
                    </div>
                    
                    <input type="hidden" id="duration_mode" name="duration_mode" value="single">
                    
                    <div class="form-buttons">
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <i class="fas fa-rocket"></i> Start Boost
                        </button>
                        <button type="button" class="btn btn-danger" id="stopBtn" disabled>
                            <i class="fas fa-stop"></i> Stop
                        </button>
                    </div>
                </form>
            </div>
            
            <div class="card">
                <h2><i class="fas fa-chart-line"></i> Statistics</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-label">Followers Sent</div>
                            <div class="stat-value" id="followCount">0</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-label">Elapsed Time</div>
                            <div class="stat-value" id="elapsedTime">0s</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-bolt"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-label">Status</div>
                            <div class="stat-value" id="botStatus">Idle</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-hourglass-half"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-label">Cooldowns</div>
                            <div class="stat-value" id="cooldownCount">0</div>
                        </div>
                    </div>
                </div>
                
                <div class="cooldown-list" id="cooldownList">
                    <!-- Cooldown list will be populated here -->
                </div>
            </div>
            
            <div class="card">
                <h2><i class="fas fa-terminal"></i> Logs & Status</h2>
                
                <div class="result" id="result"></div>
                
                <div class="logs-container">
                    <div class="logs-header">
                        <h3><i class="fas fa-history"></i> Real-time Logs</h3>
                        <button class="btn-small" id="clearLogsBtn">
                            <i class="fas fa-trash"></i> Clear Logs
                        </button>
                    </div>
                    <div class="logs" id="logs">
                        <div class="log info">
                            <i class="fas fa-info-circle"></i> Ready to start Facebook boost...
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <div class="footer-content">
                <p>
                    <i class="fas fa-shield-alt"></i> Facebook Follower Bot v2.0 |
                    <i class="fas fa-sync-alt"></i> Proxy Rotation Enabled |
                    <i class="fas fa-bolt"></i> Powered by zefame API
                </p>
                <p class="disclaimer">
                    <i class="fas fa-exclamation-triangle"></i> 
                    This tool uses zefame API which has a 24-hour cooldown per profile. 
                    For testing purposes only.
                </p>
            </div>
        </footer>
    </div>

    <script>
        // Global variables
        let eventSource = null;
        let statusInterval = null;
        let isRunning = false;
        let startTime = null;
        
        // DOM Elements
        const apiStatus = document.getElementById('apiStatus');
        const testApiBtn = document.getElementById('testApiBtn');
        const clearCacheBtn = document.getElementById('clearCacheBtn');
        const operationMode = document.getElementById('operation_mode');
        const durationGroup = document.getElementById('durationGroup');
        const submitBtn = document.getElementById('submitBtn');
        const stopBtn = document.getElementById('stopBtn');
        const resultDiv = document.getElementById('result');
        const followCountElem = document.getElementById('followCount');
        const elapsedTimeElem = document.getElementById('elapsedTime');
        const botStatusElem = document.getElementById('botStatus');
        const cooldownCountElem = document.getElementById('cooldownCount');
        const cooldownList = document.getElementById('cooldownList');
        const logsDiv = document.getElementById('logs');
        const clearLogsBtn = document.getElementById('clearLogsBtn');
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Test API on load
            testAPI();
            
            // Load initial status
            updateStatus();
            
            // Start status updates
            statusInterval = setInterval(updateStatus, 5000);
            
            // Setup operation mode toggle
            operationMode.addEventListener('change', function() {
                if (this.value === 'continuous') {
                    durationGroup.style.display = 'block';
                } else {
                    durationGroup.style.display = 'none';
                }
            });
        });
        
        // Test API function
        function testAPI() {
            apiStatus.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Testing API...';
            
            fetch('/test-api')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.api_status === 'reachable') {
                        if (data.service_available) {
                            apiStatus.innerHTML = '<i class="fas fa-check-circle"></i> API Connected & Service Available';
                            apiStatus.className = 'api-status success';
                        } else {
                            apiStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i> API Connected but Service Unavailable';
                            apiStatus.className = 'api-status warning';
                        }
                    } else {
                        apiStatus.innerHTML = '<i class="fas fa-times-circle"></i> API Connection Failed';
                        apiStatus.className = 'api-status error';
                    }
                })
                .catch(error => {
                    apiStatus.innerHTML = '<i class="fas fa-times-circle"></i> API Test Failed';
                    apiStatus.className = 'api-status error';
                });
        }
        
        // Update status function
        function updateStatus() {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    // Update stats
                    followCountElem.textContent = data.follow_count || 0;
                    botStatusElem.textContent = data.running ? 'Running' : 'Idle';
                    
                    if (data.running && startTime) {
                        const elapsed = Math.floor((Date.now() - startTime) / 1000);
                        const hours = Math.floor(elapsed / 3600);
                        const minutes = Math.floor((elapsed % 3600) / 60);
                        const seconds = elapsed % 60;
                        
                        if (hours > 0) {
                            elapsedTimeElem.textContent = `${hours}h ${minutes}m`;
                        } else if (minutes > 0) {
                            elapsedTimeElem.textContent = `${minutes}m ${seconds}s`;
                        } else {
                            elapsedTimeElem.textContent = `${seconds}s`;
                        }
                    }
                    
                    // Update cooldowns
                    const cooldowns = data.cooldown_info || [];
                    cooldownCountElem.textContent = cooldowns.length;
                    
                    // Update cooldown list
                    if (cooldowns.length > 0) {
                        let html = '<h4><i class="fas fa-hourglass-half"></i> Active Cooldowns</h4>';
                        cooldowns.forEach(cd => {
                            html += `
                                <div class="cooldown-item">
                                    <span class="cooldown-profile">${cd.profile}</span>
                                    <span class="cooldown-time">${cd.hours_left} hours left</span>
                                </div>
                            `;
                        });
                        cooldownList.innerHTML = html;
                    } else {
                        cooldownList.innerHTML = '<div class="no-cooldowns"><i class="fas fa-check-circle"></i> No active cooldowns</div>';
                    }
                })
                .catch(error => {
                    console.error('Status update error:', error);
                });
        }
        
        // Form submission
        document.getElementById('followerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            startProcess();
        });
        
        // Stop button
        stopBtn.addEventListener('click', function() {
            stopProcess();
        });
        
        // Test API button
        testApiBtn.addEventListener('click', function() {
            testAPI();
        });
        
        // Clear cache button
        clearCacheBtn.addEventListener('click', function() {
            if (confirm('Are you sure you want to clear the cooldown cache? This will reset 24-hour timers.')) {
                fetch('/clear-cooldown', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        showResult(data.success ? 'success' : 'error', data.message);
                        updateStatus();
                    });
            }
        });
        
        // Clear logs button
        clearLogsBtn.addEventListener('click', function() {
            logsDiv.innerHTML = '<div class="log info"><i class="fas fa-info-circle"></i> Logs cleared</div>';
        });
        
        // Start process function
        function startProcess() {
            const formData = new FormData(document.getElementById('followerForm'));
            const url = formData.get('facebook_url');
            const mode = formData.get('operation_mode');
            
            // Validate URL
            if (!url.includes('facebook.com')) {
                showResult('error', '‚ùå Please enter a valid Facebook URL');
                return;
            }
            
            // Prepare data
            const data = new FormData();
            data.append('facebook_url', url);
            
            if (mode === 'continuous') {
                const duration = document.getElementById('duration').value;
                data.append('duration', duration);
            } else {
                data.append('duration', '0');
            }
            
            // UI updates
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starting...';
            stopBtn.disabled = false;
            resultDiv.style.display = 'none';
            
            isRunning = true;
            startTime = Date.now();
            
            // Start SSE connection
            startEventStream();
            
            // Send request
            fetch('/start', {
                method: 'POST',
                body: data
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showResult('success', data.message);
                } else {
                    showResult('error', data.message);
                    resetUI();
                }
            })
            .catch(error => {
                showResult('error', `Network error: ${error.message}`);
                resetUI();
            });
        }
        
        // Stop process function
        function stopProcess() {
            fetch('/stop', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    showResult('info', data.message);
                    resetUI();
                })
                .catch(error => {
                    showResult('error', `Stop error: ${error.message}`);
                    resetUI();
                });
        }
        
        // Start event stream
        function startEventStream() {
            if (eventSource) {
                eventSource.close();
            }
            
            eventSource = new EventSource('/events');
            
            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                if (data.type === 'ping') return; // Skip heartbeats
                
                addLog(data.type, data.message);
                
                // Update follow count on success
                if (data.type === 'success' && data.message.includes('Order ID')) {
                    updateStatus();
                }
                
                // Handle process completion
                if (data.type === 'info' && data.message.includes('Process completed')) {
                    setTimeout(() => {
                        resetUI();
                        updateStatus();
                    }, 2000);
                }
            };
            
            eventSource.onerror = function() {
                addLog('error', 'Connection lost. Reconnecting...');
                setTimeout(startEventStream, 5000);
            };
        }
        
        // Add log entry
        function addLog(type, message) {
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            
            let icon = 'fa-info-circle';
            if (type === 'success') icon = 'fa-check-circle';
            if (type === 'error') icon = 'fa-times-circle';
            if (type === 'warning') icon = 'fa-exclamation-triangle';
            
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML = `
                <i class="fas ${icon}"></i>
                <span class="log-timestamp">[${timestamp}]</span>
                <span class="log-message">${message}</span>
            `;
            
            logsDiv.appendChild(logDiv);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }
        
        // Show result message
        function showResult(type, message) {
            resultDiv.className = `result ${type}`;
            resultDiv.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-times-circle'}"></i> ${message}`;
            resultDiv.style.display = 'block';
        }
        
        // Reset UI
        function resetUI() {
            isRunning = false;
            startTime = null;
            
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
            
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-rocket"></i> Start Boost';
            stopBtn.disabled = true;
            
            botStatusElem.textContent = 'Idle';
            elapsedTimeElem.textContent = '0s';
        }
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (eventSource) {
                eventSource.close();
            }
            if (statusInterval) {
                clearInterval(statusInterval);
            }
        });
    </script>
</body>
</html>
